@model List<EyelixEyewear_Project.Models.ViewModels.AdminProductViewModel>
@{
    ViewBag.Title = "Products Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    /* Gallery Preview Styles */
    .gallery-item {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #ddd;
    }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .gallery-item-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.3s;
    }

        .gallery-item-remove:hover {
            background: #c82333;
            transform: scale(1.1);
        }
</style>

<header>
    <h2>Products Management</h2>
    <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="search" id="searchProduct" placeholder="Search name or SKU..." onkeyup="filterProducts()">
    </div>
</header>

<div class="card">
    <div class="card-header">
        <div class="filters">
            <select id="filterCategory" onchange="filterProducts()">
                <option value="All">All Categories</option>
                @foreach (var cat in ViewBag.Categories as List<EyelixEyewear_Project.Models.Category>)
                {
                    <option value="@cat.Name">@cat.Name</option>
                }
            </select>
            <select id="filterStock" onchange="filterProducts()">
                <option value="All">All Stock</option>
                <option value="InStock">In Stock</option>
                <option value="LowStock">Low Stock (&lt; 10)</option>
                <option value="OutOfStock">Out of Stock</option>
            </select>
            <select id="filterStatus" onchange="filterProducts()">
                <option value="All">All Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
        <button class="btn-main" onclick="openProductModal()">
            <i class="fas fa-plus"></i> Add New Product
        </button>
    </div>

    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <td>Image</td>
                    <td>Name</td>
                    <td>SKU</td>
                    <td>Price</td>
                    <td>Category</td>
                    <td>Stock</td>
                    <td>Status</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody id="productTableBody">
                @foreach (var product in Model)
                {
                    <tr data-category="@product.Category" data-stock="@product.Stock" data-status="@product.Status">
                        <td>
                            <img src="@(string.IsNullOrEmpty(product.ImageUrl) ? "/images/default-product.png" : product.ImageUrl)"
                                 alt="@product.Name"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='/images/default-product.png'">
                        </td>
                        <td><strong>@product.Name</strong></td>
                        <td>@product.SKU</td>
                        <td>@product.Price.ToString("N0") VND</td>
                        <td>@product.Category</td>
                        <td>
                            @if (product.Stock == 0)
                            {
                                <span class="status out-stock">Out of Stock</span>
                            }
                            else if (product.Stock < 10)
                            {
                                <span class="status low-stock">@product.Stock (Low)</span>
                            }
                            else
                            {
                                <span class="status in-stock">@product.Stock</span>
                            }
                        </td>
                        <td>
                            <span class="status @(product.Status.ToLower())">@product.Status</span>
                        </td>
                        <td class="actions">
                            <i class="fas fa-edit edit" onclick="editProduct(@product.Id)" title="Edit"></i>
                            <i class="fas fa-toggle-@(product.Status == "Active" ? "on" : "off")"
                               style="color: @(product.Status == "Active" ? "#4caf50" : "#999");"
                               onclick="toggleProductStatus(@product.Id)"
                               title="Toggle Active/Inactive"></i>
                            <i class="fas fa-trash delete" onclick="deleteProduct(@product.Id)" title="Delete"></i>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL: Add/Edit Product -->
<div class="modal" id="productModal">
    <div class="modal-content" style="max-width: 1000px;">
        <span class="close-modal" onclick="closeModal('productModal')">&times;</span>
        <div class="modal-header">
            <h2 id="productModalTitle">Add New Product</h2>
        </div>

        <form id="productForm" onsubmit="saveProduct(event)">
            <input type="hidden" id="productId" value="0">

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Product Name *</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>SKU *</label>
                    <input type="text" id="productSKU" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Price *</label>
                    <input type="number" id="productPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Discount Price</label>
                    <input type="number" id="productDiscountPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Stock *</label>
                    <input type="number" id="productStock" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Category *</label>
                    <select id="productCategory" required>
                        <option value="">Select Category</option>
                        @foreach (var cat in ViewBag.Categories as List<EyelixEyewear_Project.Models.Category>)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Collection</label>
                    <select id="productCollection">
                        <option value="">None</option>
                        @foreach (var col in ViewBag.Collections as List<EyelixEyewear_Project.Models.Collection>)
                        {
                            <option value="@col.Id">@col.Name</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="productColor" placeholder="e.g. Black, Tortoise">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Frame Material</label>
                    <input type="text" id="productFrameMaterial" placeholder="e.g. Acetate, Metal">
                </div>
                <div class="form-group">
                    <label>Lens Material</label>
                    <input type="text" id="productLensMaterial" placeholder="e.g. Polycarbonate">
                </div>
                <div class="form-group">
                    <label>Frame Shape</label>
                    <input type="text" id="productFrameShape" placeholder="e.g. Round, Square">
                </div>
            </div>

            <!-- MAIN PRODUCT IMAGE -->
            <div class="form-group">
                <label>Main Product Image *</label>

                <div id="imagePreview" style="margin-bottom: 15px; display: none;">
                    <img id="previewImg" src="" alt="Preview"
                         style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    <button type="button" onclick="removeMainImage()"
                            style="display: block; margin-top: 10px; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-trash"></i> Remove Image
                    </button>
                </div>

                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="productImageFile" accept="image/*" style="display: none;" onchange="uploadMainImage()">
                    <button type="button" onclick="document.getElementById('productImageFile').click()"
                            class="btn-main" style="padding: 10px 20px;">
                        <i class="fas fa-upload"></i> Upload Main Image
                    </button>
                    <span id="uploadStatus" style="color: #999; font-size: 14px;"></span>
                </div>

                <input type="hidden" id="productImageUrl">
                <small style="color: #777; font-size: 13px; display: block; margin-top: 10px;">
                    This image will be displayed as the main product image
                </small>
            </div>

            <!-- GALLERY IMAGES -->
            <div class="form-group">
                <label>Additional Images (Gallery)</label>

                <!-- Gallery Preview -->
                <div id="galleryPreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <!-- Gallery images will be added here dynamically -->
                </div>

                <!-- Upload Gallery Button -->
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="galleryImageFile" accept="image/*" multiple style="display: none;" onchange="uploadGalleryImages()">
                    <button type="button" onclick="document.getElementById('galleryImageFile').click()"
                            class="btn-main" style="padding: 10px 20px; background: #28a745;">
                        <i class="fas fa-images"></i> Add Gallery Images
                    </button>
                    <span id="galleryUploadStatus" style="color: #999; font-size: 14px;"></span>
                </div>

                <small style="color: #777; font-size: 13px; display: block; margin-top: 10px;">
                    You can upload multiple images. These will be shown in the product gallery.
                </small>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" rows="3" placeholder="Product description..."></textarea>
            </div>

            <div class="form-group checkbox-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="productIsActive" checked>
                <label style="margin: 0;">Active (visible to customers)</label>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn-main" style="flex: 1; justify-content: center;">
                    <i class="fas fa-save"></i> Save Product
                </button>
                <button type="button" class="btn-main" onclick="closeModal('productModal')"
                        style="flex: 1; justify-content: center; background: #999;">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    <script>
        // Store gallery images URLs
        let galleryImages = [];

        // ==========================================
        // FILTER PRODUCTS
        // ==========================================
        function filterProducts() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const filterCat = document.getElementById('filterCategory').value;
            const filterStock = document.getElementById('filterStock').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const rows = document.querySelectorAll('#productTableBody tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const category = row.getAttribute('data-category');
                const stock = parseInt(row.getAttribute('data-stock'));
                const status = row.getAttribute('data-status');

                const matchSearch = text.includes(searchTerm);
                const matchCategory = filterCat === 'All' || category === filterCat;
                const matchStock = filterStock === 'All' ||
                    (filterStock === 'InStock' && stock > 0) ||
                    (filterStock === 'LowStock' && stock > 0 && stock < 10) ||
                    (filterStock === 'OutOfStock' && stock === 0);
                const matchStatus = filterStatus === 'All' || status === filterStatus;

                row.style.display = (matchSearch && matchCategory && matchStock && matchStatus) ? '' : 'none';
            });
        }

        // ==========================================
        // OPEN MODAL FOR ADD
        // ==========================================
        function openProductModal() {
            document.getElementById('productModalTitle').innerText = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '0';
            document.getElementById('productIsActive').checked = true;

            // Reset images
            document.getElementById('productImageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
            document.getElementById('uploadStatus').innerText = '';

            // Reset gallery
            galleryImages = [];
            document.getElementById('galleryPreview').innerHTML = '';
            document.getElementById('galleryUploadStatus').innerText = '';

            document.getElementById('productCollection').value = '';
            document.getElementById('productModal').classList.add('active');
        }

        // ==========================================
        // OPEN MODAL FOR EDIT
        // ==========================================
        function editProduct(id) {
            fetch(`/Admin/GetProduct?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('productModalTitle').innerText = 'Edit Product';
                    document.getElementById('productId').value = data.id;
                    document.getElementById('productName').value = data.name;
                    document.getElementById('productSKU').value = data.sku;
                    document.getElementById('productPrice').value = data.price;
                    document.getElementById('productDiscountPrice').value = data.discountPrice || '';
                    document.getElementById('productStock').value = data.stock;
                    document.getElementById('productCategory').value = data.categoryId;
                    document.getElementById('productCollection').value = data.collectionId || '';
                    document.getElementById('productColor').value = data.color || '';
                    document.getElementById('productFrameMaterial').value = data.frameMaterial || '';
                    document.getElementById('productLensMaterial').value = data.lensMaterial || '';
                    document.getElementById('productFrameShape').value = data.frameShape || '';
                    document.getElementById('productDescription').value = data.description || '';
                    document.getElementById('productIsActive').checked = data.isActive;

                    // Set main image
                    document.getElementById('productImageUrl').value = data.imageUrl || '';
                    if (data.imageUrl) {
                        document.getElementById('previewImg').src = data.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        document.getElementById('imagePreview').style.display = 'none';
                    }

                    // Load gallery images
                    galleryImages = [];
                    const galleryPreview = document.getElementById('galleryPreview');
                    galleryPreview.innerHTML = '';

                    if (data.galleryImages && data.galleryImages.length > 0) {
                        data.galleryImages.forEach(img => {
                            galleryImages.push(img.url);
                            addGalleryPreview(img.url, img.id);
                        });
                    }

                    document.getElementById('uploadStatus').innerText = '';
                    document.getElementById('galleryUploadStatus').innerText = '';
                    document.getElementById('productModal').classList.add('active');
                })
                .catch(error => {
                    alert('Error loading product data');
                    console.error('Error:', error);
                });
        }

        // ==========================================
        // UPLOAD MAIN IMAGE
        // ==========================================
        function uploadMainImage() {
            const fileInput = document.getElementById('productImageFile');
            const file = fileInput.files[0];

            if (!file) return;

            document.getElementById('uploadStatus').innerText = 'Uploading...';
            document.getElementById('uploadStatus').style.color = '#667eea';

            const formData = new FormData();
            formData.append('file', file);

            fetch('/Admin/UploadProductImage', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('productImageUrl').value = result.imageUrl;
                    document.getElementById('previewImg').src = result.imageUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('uploadStatus').innerText = 'Upload successful!';
                    document.getElementById('uploadStatus').style.color = '#4caf50';
                    fileInput.value = '';
                } else {
                    alert(result.message);
                    document.getElementById('uploadStatus').innerText = 'Upload failed';
                    document.getElementById('uploadStatus').style.color = '#dc3545';
                }
            })
            .catch(error => {
                alert('Error uploading image: ' + error);
                document.getElementById('uploadStatus').innerText = 'Upload failed';
                document.getElementById('uploadStatus').style.color = '#dc3545';
            });
        }

        // ==========================================
        // UPLOAD GALLERY IMAGES
        // ==========================================
        function uploadGalleryImages() {
            const fileInput = document.getElementById('galleryImageFile');
            const files = fileInput.files;

            if (!files || files.length === 0) return;

            document.getElementById('galleryUploadStatus').innerText = `Uploading ${files.length} image(s)...`;
            document.getElementById('galleryUploadStatus').style.color = '#667eea';

            let uploadedCount = 0;
            let failedCount = 0;

            Array.from(files).forEach(file => {
                const formData = new FormData();
                formData.append('file', file);

                fetch('/Admin/UploadProductImage', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        galleryImages.push(result.imageUrl);
                        addGalleryPreview(result.imageUrl);
                        uploadedCount++;
                    } else {
                        failedCount++;
                    }

                    // Update status when all uploads complete
                    if (uploadedCount + failedCount === files.length) {
                        if (failedCount === 0) {
                            document.getElementById('galleryUploadStatus').innerText =
                                `${uploadedCount} image(s) uploaded successfully!`;
                            document.getElementById('galleryUploadStatus').style.color = '#4caf50';
                        } else {
                            document.getElementById('galleryUploadStatus').innerText =
                                `${uploadedCount} uploaded, ${failedCount} failed`;
                            document.getElementById('galleryUploadStatus').style.color = '#ff9800';
                        }
                        fileInput.value = '';
                    }
                })
                .catch(error => {
                    failedCount++;
                    console.error('Upload error:', error);
                });
            });
        }

        // ==========================================
        // ADD GALLERY PREVIEW
        // ==========================================
        function addGalleryPreview(imageUrl, imageId = null) {
            const galleryPreview = document.getElementById('galleryPreview');
            const index = galleryImages.length - 1;

            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            galleryItem.dataset.imageId = imageId || '';
            galleryItem.innerHTML = `
                <img src="${imageUrl}" alt="Gallery Image">
                <button type="button" class="gallery-item-remove"
                        onclick="removeGalleryImage(${index}, ${imageId || 'null'})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            galleryPreview.appendChild(galleryItem);
        }

        // ==========================================
        // REMOVE GALLERY IMAGE
        // ==========================================
        function removeGalleryImage(index, imageId) {
            if (!confirm('Remove this image from gallery?')) return;

            // If editing existing product with saved image
            if (imageId) {
                fetch('/Admin/DeleteGalleryImage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `imageId=${imageId}`
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        removeGalleryPreviewItem(index);
                    } else {
                        alert(result.message);
                    }
                });
            } else {
                removeGalleryPreviewItem(index);
            }
        }

        function removeGalleryPreviewItem(index) {
            galleryImages.splice(index, 1);

            // Rebuild gallery preview
            const galleryPreview = document.getElementById('galleryPreview');
            galleryPreview.innerHTML = '';

            galleryImages.forEach((url, idx) => {
                addGalleryPreview(url);
            });
        }

        // ==========================================
        // REMOVE MAIN IMAGE
        // ==========================================
        function removeMainImage() {
            if (!confirm('Remove main product image?')) return;

            document.getElementById('productImageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
            document.getElementById('uploadStatus').innerText = '';
        }

        // ==========================================
        // SAVE PRODUCT
        // ==========================================
        function saveProduct(event) {
            event.preventDefault();

            const id = document.getElementById('productId').value;
            const collectionValue = document.getElementById('productCollection').value;

            const data = {
                id: parseInt(id),
                name: document.getElementById('productName').value,
                sku: document.getElementById('productSKU').value,
                price: parseFloat(document.getElementById('productPrice').value),
                discountPrice: document.getElementById('productDiscountPrice').value || null,
                stock: parseInt(document.getElementById('productStock').value),
                categoryId: parseInt(document.getElementById('productCategory').value),
                collectionId: collectionValue ? parseInt(collectionValue) : null,
                color: document.getElementById('productColor').value || null,
                frameMaterial: document.getElementById('productFrameMaterial').value || null,
                lensMaterial: document.getElementById('productLensMaterial').value || null,
                frameShape: document.getElementById('productFrameShape').value || null,
                imageUrl: document.getElementById('productImageUrl').value || null,
                description: document.getElementById('productDescription').value || null,
                isActive: document.getElementById('productIsActive').checked,
                galleryImages: galleryImages
            };

            console.log('Saving product:', data);

            const url = id === '0' ? '/Admin/AddProduct' : '/Admin/EditProduct';

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    closeModal('productModal');
                    location.reload();
                } else {
                    alert(result.message);
                }
            })
            .catch(error => {
                alert('Error saving product');
                console.error('Error:', error);
            });
        }

        // ==========================================
        // TOGGLE PRODUCT STATUS
        // ==========================================
        function toggleProductStatus(id) {
            if (!confirm('Toggle product status?')) return;

            fetch('/Admin/ToggleProductStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                }
            });
        }

        // ==========================================
        // DELETE PRODUCT
        // ==========================================
        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) return;

            fetch('/Admin/DeleteProduct', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                }
            });
        }

        // ==========================================
        // CLOSE MODAL
        // ==========================================
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
    </script>
}