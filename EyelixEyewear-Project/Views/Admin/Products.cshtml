@model List<EyelixEyewear_Project.Models.ViewModels.AdminProductViewModel>
@{
    ViewBag.Title = "Products Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<header>
    <h2>Products Management</h2>
    <div class="search-wrapper">
        <i class="fas fa-search"></i>
        <input type="search" id="searchProduct" placeholder="Search name or SKU..." onkeyup="filterProducts()">
    </div>
</header>

<div class="card">
    <div class="card-header">
        <div class="filters">
            <select id="filterCategory" onchange="filterProducts()">
                <option value="All">All Categories</option>
                @foreach (var cat in ViewBag.Categories as List<EyelixEyewear_Project.Models.Category>)
                {
                    <option value="@cat.Name">@cat.Name</option>
                }
            </select>
            <select id="filterStock" onchange="filterProducts()">
                <option value="All">All Stock</option>
                <option value="InStock">In Stock</option>
                <option value="LowStock">Low Stock (&lt; 10)</option>
                <option value="OutOfStock">Out of Stock</option>
            </select>
            <select id="filterStatus" onchange="filterProducts()">
                <option value="All">All Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
        <button class="btn-main" onclick="openProductModal()">
            <i class="fas fa-plus"></i> Add New Product
        </button>
    </div>

    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <td>Image</td>
                    <td>Name</td>
                    <td>SKU</td>
                    <td>Price</td>
                    <td>Category</td>
                    <td>Stock</td>
                    <td>Status</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody id="productTableBody">
                @foreach (var product in Model)
                {
                    <tr data-category="@product.Category" data-stock="@product.Stock" data-status="@product.Status">
                        <td>
                            <img src="@(string.IsNullOrEmpty(product.ImageUrl) ? "/images/default-product.png" : product.ImageUrl)"
                                 alt="@product.Name"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                 onerror="this.src='/images/default-product.png'">
                        </td>
                        <td><strong>@product.Name</strong></td>
                        <td>@product.SKU</td>
                        <td>@product.Price.ToString("N0") VND</td>
                        <td>@product.Category</td>
                        <td>
                            @if (product.Stock == 0)
                            {
                                <span class="status out-stock">Out of Stock</span>
                            }
                            else if (product.Stock < 10)
                            {
                                <span class="status low-stock">@product.Stock (Low)</span>
                            }
                            else
                            {
                                <span class="status in-stock">@product.Stock</span>
                            }
                        </td>
                        <td>
                            <span class="status @(product.Status.ToLower())">@product.Status</span>
                        </td>
                        <td class="actions">
                            <i class="fas fa-edit edit" onclick="editProduct(@product.Id)" title="Edit"></i>
                            <i class="fas fa-toggle-@(product.Status == "Active" ? "on" : "off")"
                               style="color: @(product.Status == "Active" ? "#4caf50" : "#999");"
                               onclick="toggleProductStatus(@product.Id)"
                               title="Toggle Active/Inactive"></i>
                            <i class="fas fa-trash delete" onclick="deleteProduct(@product.Id)" title="Delete"></i>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL: Add/Edit Product -->
<div class="modal" id="productModal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close-modal" onclick="closeModal('productModal')">&times;</span>
        <div class="modal-header">
            <h2 id="productModalTitle">Add New Product</h2>
        </div>

        <form id="productForm" onsubmit="saveProduct(event)">
            <input type="hidden" id="productId" value="0">

            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Product Name *</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>SKU *</label>
                    <input type="text" id="productSKU" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Price *</label>
                    <input type="number" id="productPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Discount Price</label>
                    <input type="number" id="productDiscountPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Stock *</label>
                    <input type="number" id="productStock" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Category *</label>
                    <select id="productCategory" required>
                        <option value="">Select Category</option>
                        @foreach (var cat in ViewBag.Categories as List<EyelixEyewear_Project.Models.Category>)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>
                </div>
                   
                <div class="form-group">
                    <label>Collection</label>
                    <select id="productCollection">
                        <option value="">None</option>
                        @foreach (var col in ViewBag.Collections as List<EyelixEyewear_Project.Models.Collection>)
                        {
                            <option value="@col.Id">@col.Name</option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="productColor" placeholder="e.g. Black, Tortoise">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Frame Material</label>
                    <input type="text" id="productFrameMaterial" placeholder="e.g. Acetate, Metal">
                </div>
                <div class="form-group">
                    <label>Lens Material</label>
                    <input type="text" id="productLensMaterial" placeholder="e.g. Polycarbonate">
                </div>
                <div class="form-group">
                    <label>Frame Shape</label>
                    <input type="text" id="productFrameShape" placeholder="e.g. Round, Square">
                </div>
            </div>

            <div class="form-group">
                <label>Product Image</label>

                <!-- Preview ảnh -->
                <div id="imagePreview" style="margin-bottom: 15px; display: none;">
                    <img id="previewImg" src="" alt="Preview"
                         style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #ddd;">
                    <button type="button" onclick="removeImage()"
                            style="display: block; margin-top: 10px; padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-trash"></i> Remove Image
                    </button>
                </div>

                <!-- Upload button -->
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="productImageFile" accept="image/*" style="display: none;" onchange="uploadImage()">
                    <button type="button" onclick="document.getElementById('productImageFile').click()"
                            class="btn-main" style="padding: 10px 20px;">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                    <span id="uploadStatus" style="color: #999; font-size: 14px;"></span>
                </div>

                <!-- Hidden input chứa URL -->
                <input type="hidden" id="productImageUrl">

                <small style="color: #777; font-size: 13px; display: block; margin-top: 10px;">
                    Allowed: JPG, PNG, GIF, WEBP (Max 5MB)
                </small>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="productDescription" rows="3" placeholder="Product description..."></textarea>
            </div>

            <div class="form-group checkbox-group" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="productIsActive" checked>
                <label style="margin: 0;">Active (visible to customers)</label>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn-main" style="flex: 1; justify-content: center;">
                    <i class="fas fa-save"></i> Save Product
                </button>
                <button type="button" class="btn-main" onclick="closeModal('productModal')"
                        style="flex: 1; justify-content: center; background: #999;">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // ==========================================
        // FILTER PRODUCTS
        // ==========================================
        function filterProducts() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const filterCat = document.getElementById('filterCategory').value;
            const filterStock = document.getElementById('filterStock').value;
            const filterStatus = document.getElementById('filterStatus').value;
            const rows = document.querySelectorAll('#productTableBody tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                const category = row.getAttribute('data-category');
                const stock = parseInt(row.getAttribute('data-stock'));
                const status = row.getAttribute('data-status');

                const matchSearch = text.includes(searchTerm);
                const matchCategory = filterCat === 'All' || category === filterCat;
                const matchStock = filterStock === 'All' ||
                    (filterStock === 'InStock' && stock > 0) ||
                    (filterStock === 'LowStock' && stock > 0 && stock < 10) ||
                    (filterStock === 'OutOfStock' && stock === 0);
                const matchStatus = filterStatus === 'All' || status === filterStatus;

                row.style.display = (matchSearch && matchCategory && matchStock && matchStatus) ? '' : 'none';
            });
        }

        // ==========================================
        // OPEN MODAL FOR ADD
        // ==========================================
        function openProductModal() {
            document.getElementById('productModalTitle').innerText = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '0';
            document.getElementById('productIsActive').checked = true;

            // Reset image preview
            document.getElementById('productImageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
            document.getElementById('uploadStatus').innerText = '';

            // Reset collection
            document.getElementById('productCollection').value = '';

            document.getElementById('productModal').classList.add('active');
        }

        // ==========================================
        // OPEN MODAL FOR EDIT
        // ==========================================
        function editProduct(id) {
            console.log('Editing product ID:', id);

            fetch(`/Admin/GetProduct?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Product data received:', data);

                    document.getElementById('productModalTitle').innerText = 'Edit Product';
                    document.getElementById('productId').value = data.id;
                    document.getElementById('productName').value = data.name;
                    document.getElementById('productSKU').value = data.sku;
                    document.getElementById('productPrice').value = data.price;
                    document.getElementById('productDiscountPrice').value = data.discountPrice || '';
                    document.getElementById('productStock').value = data.stock;
                    document.getElementById('productCategory').value = data.categoryId;

                    // ✅ SET COLLECTION VALUE
                    const collectionSelect = document.getElementById('productCollection');
                    collectionSelect.value = data.collectionId || '';
                    console.log('Collection set to:', collectionSelect.value);

                    document.getElementById('productColor').value = data.color || '';
                    document.getElementById('productFrameMaterial').value = data.frameMaterial || '';
                    document.getElementById('productLensMaterial').value = data.lensMaterial || '';
                    document.getElementById('productFrameShape').value = data.frameShape || '';
                    document.getElementById('productDescription').value = data.description || '';
                    document.getElementById('productIsActive').checked = data.isActive;

                    // Set image
                    document.getElementById('productImageUrl').value = data.imageUrl || '';
                    if (data.imageUrl) {
                        document.getElementById('previewImg').src = data.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                    document.getElementById('uploadStatus').innerText = '';

                    document.getElementById('productModal').classList.add('active');
                })
                .catch(error => {
                    alert('Error loading product data');
                    console.error('Error:', error);
                });
        }

        // ==========================================
        // UPLOAD IMAGE
        // ==========================================
        function uploadImage() {
            const fileInput = document.getElementById('productImageFile');
            const file = fileInput.files[0];

            if (!file) return;

            // Show loading
            document.getElementById('uploadStatus').innerText = 'Uploading...';
            document.getElementById('uploadStatus').style.color = '#667eea';

            // Create FormData
            const formData = new FormData();
            formData.append('file', file);

            // Upload
            fetch('/Admin/UploadProductImage', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('productImageUrl').value = result.imageUrl;
                    document.getElementById('previewImg').src = result.imageUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('uploadStatus').innerText = 'Upload successful!';
                    document.getElementById('uploadStatus').style.color = '#4caf50';
                    fileInput.value = '';
                } else {
                    alert(result.message);
                    document.getElementById('uploadStatus').innerText = 'Upload failed';
                    document.getElementById('uploadStatus').style.color = '#dc3545';
                }
            })
            .catch(error => {
                alert('Error uploading image: ' + error);
                document.getElementById('uploadStatus').innerText = 'Upload failed';
                document.getElementById('uploadStatus').style.color = '#dc3545';
            });
        }

        // ==========================================
        // REMOVE IMAGE
        // ==========================================
        function removeImage() {
            if (!confirm('Remove this image?')) return;

            document.getElementById('productImageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
            document.getElementById('uploadStatus').innerText = '';
        }

        // ==========================================
        // SAVE PRODUCT
        // ==========================================
        function saveProduct(event) {
            event.preventDefault();

            const id = document.getElementById('productId').value;
            const collectionValue = document.getElementById('productCollection').value;

            const data = {
                id: parseInt(id),
                name: document.getElementById('productName').value,
                sku: document.getElementById('productSKU').value,
                price: parseFloat(document.getElementById('productPrice').value),
                discountPrice: document.getElementById('productDiscountPrice').value || null,
                stock: parseInt(document.getElementById('productStock').value),
                categoryId: parseInt(document.getElementById('productCategory').value),
                collectionId: collectionValue ? parseInt(collectionValue) : null,
                color: document.getElementById('productColor').value || null,
                frameMaterial: document.getElementById('productFrameMaterial').value || null,
                lensMaterial: document.getElementById('productLensMaterial').value || null,
                frameShape: document.getElementById('productFrameShape').value || null,
                imageUrl: document.getElementById('productImageUrl').value || null,
                description: document.getElementById('productDescription').value || null,
                isActive: document.getElementById('productIsActive').checked
            };

            // Debug log
            console.log('Saving product with data:', data);
            console.log('CollectionId:', data.collectionId);

            const url = id === '0' ? '/Admin/AddProduct' : '/Admin/EditProduct';

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('Save result:', result);
                if (result.success) {
                    alert(result.message);
                    closeModal('productModal');
                    location.reload();
                } else {
                    alert(result.message);
                }
            })
            .catch(error => {
                alert('Error saving product');
                console.error('Error:', error);
            });
        }

        // ==========================================
        // TOGGLE PRODUCT STATUS
        // ==========================================
        function toggleProductStatus(id) {
            if (!confirm('Toggle product status?')) return;

            fetch('/Admin/ToggleProductStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                }
            });
        }

        // ==========================================
        // DELETE PRODUCT
        // ==========================================
        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) return;

            fetch('/Admin/DeleteProduct', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                }
            });
        }

        // ==========================================
        // CLOSE MODAL
        // ==========================================
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
    </script>
}